import React, { useState, useEffect, useReducer, useRef, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import {
  getFirestore, doc, setDoc, serverTimestamp, collection, onSnapshot, query, limit
} from 'firebase/firestore';
import {
  getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged
} from 'firebase/auth';

/**
 * SOVEREIGN LITE v86.28
 * Rate Limit Mitigation & Exponential Backoff
 */

// --- Configuration & Constants ---

const APP_CONFIG = Object.freeze({
  MAX_FILE_SIZE_BYTES: 500_000,
  CYCLE_INTERVAL_MS: 6000, // Slightly increased to reduce pressure
  MAX_API_RETRIES: 5,
  API_TIMEOUT_MS: 60_000,
  LOCAL_STORAGE_PREFIX: 'sov_v86_',
  LOG_HISTORY_LIMIT: 40,
  APP_ID: typeof __app_id !== 'undefined' ? __app_id : 'sovereign-lite-v86',
});

const API_MODELS = Object.freeze([
  { id: 'gemini-2.5-flash-preview-09-2025', label: 'Flash 2.5 Preview', tier: 1 },
  { id: 'gemini-1.5-flash', label: 'Flash 1.5 Stable', tier: 2 }
]);

const PROCESSING_PIPELINES = Object.freeze({
  CODE: [
    { id: 'refactor', label: 'Optimizing Architecture', text: 'Act as a Principal Software Engineer. Refactor the following code for maximum performance, clarity, and strict adherence to modern design patterns. Return ONLY the code.' }
  ],
  MARKDOWN: [
    { id: 'prose', label: 'Improving Clarity', text: 'Act as a Technical Writer. Enhance the documentation for clarity and professional tone. Return ONLY the updated markdown.' }
  ]
});

const FILE_EXTENSIONS = Object.freeze({
  CODE: /\.(js|jsx|ts|tsx|py|html|css|cpp|rs|go|php|java|sql)$/i,
  DOCS: /\.(md|txt|adoc)$/i
});

const SKIP_PATTERNS = Object.freeze([
  /node_modules\//, /\.min\./, /-lock\./, /dist\//, /build\//, /\.git\//, /\.png$|\.jpg$|\.jpeg$|\.gif$/i
]);

const GITHUB_API_BASE = 'https://api.github.com/repos';
const GEMINI_API_BASE = 'https://generativelanguage.googleapis.com/v1beta/models';

// --- Utilities ---

const decodeB64 = (str) => {
  try {
    return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
  } catch (e) { return ''; }
};

const encodeB64 = (str) => {
  try {
    return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
  } catch (e) { return ''; }
};

const parseRepo = (path) => {
  const match = path.replace('https://github.com/', '').match(/^([^/]+)\/([^/]+)/);
  return match ? { owner: match[1], repo: match[2] } : null;
};

// --- State Management ---

const INITIAL_STATE = {
  isLive: false,
  isIndexed: false,
  isComplete: false,
  status: 'IDLE',
  activePath: 'Ready for Uplink',
  selectedModel: localStorage.getItem(APP_CONFIG.LOCAL_STORAGE_PREFIX + 'model') || API_MODELS[0].id,
  targetRepo: localStorage.getItem(APP_CONFIG.LOCAL_STORAGE_PREFIX + 'repo') || '',
  logs: [],
  metrics: { mutations: 0, steps: 0, errors: 0, progress: 0, totalFiles: 0 }
};

function reducer(state, action) {
  switch (action.type) {
    case 'SET_REPO':
      localStorage.setItem(APP_CONFIG.LOCAL_STORAGE_PREFIX + 'repo', action.payload);
      return { ...state, targetRepo: action.payload };
    case 'SET_MODEL':
      localStorage.setItem(APP_CONFIG.LOCAL_STORAGE_PREFIX + 'model', action.payload);
      return { ...state, selectedModel: action.payload };
    case 'TOGGLE_LIVE':
      return { ...state, isLive: !state.isLive, status: !state.isLive ? 'INITIALIZING' : 'HALTED' };
    case 'SET_INDEXED':
      return { ...state, isIndexed: action.payload.value, metrics: { ...state.metrics, totalFiles: action.payload.total || 0 } };
    case 'UPDATE_METRICS':
      return { 
        ...state, 
        metrics: { 
          ...state.metrics, 
          ...action.payload,
          progress: action.payload.cursor ? Math.floor((action.payload.cursor / state.metrics.totalFiles) * 100) : state.metrics.progress
        } 
      };
    case 'ADD_LOG':
      return { ...state, logs: [{ ...action.payload, id: Math.random() }, ...state.logs].slice(0, APP_CONFIG.LOG_HISTORY_LIMIT) };
    case 'SET_STATUS':
      return { ...state, status: action.payload.text, activePath: action.payload.path || state.activePath };
    case 'COMPLETE':
      return { ...state, isLive: false, isComplete: true, status: 'FINISHED', activePath: 'System Nominal' };
    case 'RESET':
      return { ...INITIAL_STATE, targetRepo: state.targetRepo, selectedModel: state.selectedModel };
    default: return state;
  }
}

// --- Main Component ---

export default function App() {
  const [state, dispatch] = useReducer(reducer, INITIAL_STATE);
  const [user, setUser] = useState(null);
  
  const ghTokenRef = useRef('');
  const geminiKeyRef = useRef('');
  const queueRef = useRef([]);
  const cursorRef = useRef(0);
  const abortRef = useRef(null);

  const { isLive, isIndexed, isComplete, status, activePath, metrics, logs, targetRepo, selectedModel } = state;

  useEffect(() => {
    if (typeof __firebase_config === 'undefined') return;
    const app = initializeApp(JSON.parse(__firebase_config));
    const auth = getAuth(app);
    
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) { console.error("Auth Error", err); }
    };

    initAuth();
    return onAuthStateChanged(auth, setUser);
  }, []);

  const addLog = useCallback((msg, type = 'info') => {
    dispatch({ type: 'ADD_LOG', payload: { msg, type, timestamp: new Date().toLocaleTimeString() } });
  }, []);

  // Updated with Exponential Backoff
  const apiCall = useCallback(async (url, options, retries = APP_CONFIG.MAX_API_RETRIES) => {
    for (let i = 0; i <= retries; i++) {
      try {
        const res = await fetch(url, { ...options, signal: abortRef.current?.signal });
        
        // Handle Rate Limiting (429) or Server Errors (500+)
        if (res.status === 429 || (res.status >= 500 && i < retries)) {
          const delay = Math.pow(2, i) * 1000;
          if (res.status === 429) addLog(`Rate limited. Waiting ${delay/1000}s...`, "info");
          await new Promise(r => setTimeout(r, delay));
          continue;
        }

        const data = await res.json();
        if (!res.ok) {
          const err = new Error(data.error?.message || `HTTP ${res.status}`);
          err.status = res.status;
          err.details = data;
          throw err;
        }
        return data;
      } catch (e) {
        if (i === retries) throw e;
        // Simple backoff for network errors
        await new Promise(r => setTimeout(r, 1000));
      }
    }
  }, [addLog]);

  const discover = async () => {
    const repoInfo = parseRepo(targetRepo);
    if (!repoInfo || !ghTokenRef.current) return addLog("Invalid Repo or Token", "error");

    dispatch({ type: 'SET_STATUS', payload: { text: 'INDEXING' } });
    try {
      const headers = { 'Authorization': `token ${ghTokenRef.current}`, 'Accept': 'application/vnd.github.v3+json' };
      const repoData = await apiCall(`${GITHUB_API_BASE}/${repoInfo.owner}/${repoInfo.repo}`, { headers });
      const tree = await apiCall(`${GITHUB_API_BASE}/${repoInfo.owner}/${repoInfo.repo}/git/trees/${repoData.default_branch}?recursive=1`, { headers });
      
      const filtered = tree.tree.filter(f => 
        f.type === 'blob' && 
        !SKIP_PATTERNS.some(p => p.test(f.path)) &&
        (FILE_EXTENSIONS.CODE.test(f.path) || FILE_EXTENSIONS.DOCS.test(f.path))
      ).map(f => f.path);

      queueRef.current = filtered;
      cursorRef.current = 0;
      dispatch({ type: 'SET_INDEXED', payload: { value: true, total: filtered.length } });
      addLog(`Indexed ${filtered.length} relevant targets.`, "success");
    } catch (e) {
      addLog(`Index Failed: ${e.message}`, "error");
    } finally {
      dispatch({ type: 'SET_STATUS', payload: { text: 'READY' } });
    }
  };

  const processNext = useCallback(async () => {
    if (!isLive || cursorRef.current >= queueRef.current.length) {
      if (isLive) dispatch({ type: 'COMPLETE' });
      return;
    }

    const path = queueRef.current[cursorRef.current];
    const repoInfo = parseRepo(targetRepo);
    const headers = { 'Authorization': `token ${ghTokenRef.current}`, 'Accept': 'application/vnd.github.v3+json' };

    try {
      dispatch({ type: 'SET_STATUS', payload: { text: 'FETCHING', path } });
      const fileData = await apiCall(`${GITHUB_API_BASE}/${repoInfo.owner}/${repoInfo.repo}/contents/${path}`, { headers });
      const content = decodeB64(fileData.content);
      let latestSha = fileData.sha; 
      
      const pipeline = FILE_EXTENSIONS.DOCS.test(path) ? PROCESSING_PIPELINES.MARKDOWN : PROCESSING_PIPELINES.CODE;
      let workingContent = content;
      let mutated = false;

      for (const step of pipeline) {
        dispatch({ type: 'SET_STATUS', payload: { text: step.label, path } });
        
        const aiUrl = `${GEMINI_API_BASE}/${selectedModel}:generateContent?key=${geminiKeyRef.current}`;
        const aiRes = await apiCall(aiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: `${step.text}\n\nFILE:\n${workingContent}` }] }],
            generationConfig: { temperature: 0.1 },
            safetySettings: [
              { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
              { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
              { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
              { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
            ]
          })
        });

        // Robust parsing to avoid 'candidates of undefined'
        const candidate = aiRes?.candidates?.[0];
        if (!candidate) {
          const blockReason = aiRes?.promptFeedback?.blockReason || "Unknown API logic blockage";
          throw new Error(`AI Empty: ${blockReason}`);
        }

        const resultText = candidate.content?.parts?.[0]?.text?.replace(/^```[a-z]*\n|```$/gi, '').trim();
        
        if (resultText && resultText !== workingContent) {
          workingContent = resultText;
          mutated = true;
        }
      }

      if (mutated) {
        dispatch({ type: 'SET_STATUS', payload: { text: 'RE-VALIDATING', path } });
        const fresh = await apiCall(`${GITHUB_API_BASE}/${repoInfo.owner}/${repoInfo.repo}/contents/${path}`, { headers });
        latestSha = fresh.sha;

        dispatch({ type: 'SET_STATUS', payload: { text: 'COMMITTING', path } });
        await apiCall(`${GITHUB_API_BASE}/${repoInfo.owner}/${repoInfo.repo}/contents/${path}`, {
          method: 'PUT',
          headers: { ...headers, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: `[Sovereign] Sync: ${path.split('/').pop()}`,
            content: encodeB64(workingContent),
            sha: latestSha
          })
        });
        addLog(`Synchronized: ${path.split('/').pop()}`, "success");
        dispatch({ type: 'UPDATE_METRICS', payload: { mutations: metrics.mutations + 1 } });
        
        if (user) {
          const db = getFirestore();
          setDoc(doc(db, 'artifacts', APP_CONFIG.APP_ID, 'users', user.uid, 'syncs', Date.now().toString()), {
            path, status: 'MUTATED', timestamp: serverTimestamp()
          });
        }
      } else {
        addLog(`Verified: ${path.split('/').pop()}`, "info");
      }
    } catch (e) {
      if (e.name !== 'AbortError') {
        const msg = e.status === 409 ? "Conflict - Auto-skipping" : e.message;
        addLog(`Fault @ ${path.split('/').pop()}: ${msg}`, "error");
        dispatch({ type: 'UPDATE_METRICS', payload: { errors: metrics.errors + 1 } });
      }
    } finally {
      cursorRef.current++;
      dispatch({ type: 'UPDATE_METRICS', payload: { cursor: cursorRef.current } });
    }
  }, [isLive, targetRepo, selectedModel, metrics, user, apiCall, addLog]);

  useEffect(() => {
    let timer;
    if (isLive) {
      abortRef.current = new AbortController();
      timer = setInterval(processNext, APP_CONFIG.CYCLE_INTERVAL_MS);
      processNext();
    }
    return () => {
      clearInterval(timer);
      abortRef.current?.abort();
    };
  }, [isLive, processNext]);

  return (
    <div className="min-h-screen bg-[#050505] text-zinc-400 font-mono p-4 md:p-8">
      <div className="max-w-6xl mx-auto space-y-6">
        <header className="bg-zinc-900/40 border border-white/5 p-8 rounded-[2.5rem] flex flex-col md:flex-row justify-between items-center gap-6">
          <div className="flex items-center gap-6">
            <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-2xl border transition-all ${isLive ? 'border-emerald-500/50 bg-emerald-500/10 text-emerald-500 animate-pulse' : 'border-zinc-800 bg-zinc-900'}`}>
              {isLive ? 'üì°' : 'üßä'}
            </div>
            <div>
              <h1 className="text-xl font-black text-white uppercase italic tracking-tighter">Sovereign <span className="text-emerald-500">Lite</span></h1>
              <div className="flex items-center gap-3 mt-1 text-[10px] font-bold uppercase tracking-widest">
                <span className={isLive ? 'text-emerald-500' : 'text-zinc-600'}>{status}</span>
                <span className="text-zinc-800">|</span>
                <span className="text-zinc-500 truncate max-w-[150px]">{activePath}</span>
              </div>
            </div>
          </div>
          <div className="flex gap-3">
            {isComplete && <button onClick={() => dispatch({type:'RESET'})} className="px-6 py-4 bg-zinc-800 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-zinc-700 transition-all">Reset</button>}
            <button 
              onClick={() => isIndexed ? dispatch({type:'TOGGLE_LIVE'}) : discover()}
              className={`px-10 py-4 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${isLive ? 'bg-red-600 text-white' : 'bg-white text-black hover:scale-105'}`}
            >
              {isLive ? 'Abort Mission' : isIndexed ? 'Engage Core' : 'Initialize'}
            </button>
          </div>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
          <aside className="lg:col-span-4 space-y-6">
            <div className="bg-zinc-900/40 border border-white/5 p-6 rounded-[2rem] space-y-5">
              <div className="space-y-2">
                <label className="text-[9px] font-black uppercase text-zinc-600 tracking-tighter">Target Repository</label>
                <input 
                  value={targetRepo} 
                  onChange={e => dispatch({type:'SET_REPO', payload: e.target.value})}
                  className="w-full bg-black border border-white/5 rounded-lg p-4 text-xs text-white focus:border-emerald-500/50 outline-none transition-all"
                  placeholder="owner/repo"
                />
              </div>
              <div className="space-y-2">
                <label className="text-[9px] font-black uppercase text-zinc-600 tracking-tighter">GitHub Access Token</label>
                <input 
                  type="password"
                  onChange={e => ghTokenRef.current = e.target.value}
                  className="w-full bg-black border border-white/5 rounded-lg p-4 text-xs text-white focus:border-emerald-500/50 outline-none transition-all"
                  placeholder="ghp_****************"
                />
              </div>
              <div className="space-y-2">
                <label className="text-[9px] font-black uppercase text-zinc-600 tracking-tighter">Gemini API Key</label>
                <input 
                  type="password"
                  onChange={e => geminiKeyRef.current = e.target.value}
                  className="w-full bg-black border border-white/5 rounded-lg p-4 text-xs text-white focus:border-emerald-500/50 outline-none transition-all"
                  placeholder="AIza****************"
                />
              </div>
            </div>

            <div className="bg-zinc-900/40 border border-white/5 p-6 rounded-[2rem] space-y-3">
              <h3 className="text-[9px] font-black uppercase text-zinc-600">Cognitive Cluster</h3>
              {API_MODELS.map(m => (
                <button 
                  key={m.id}
                  onClick={() => dispatch({type:'SET_MODEL', payload:m.id})}
                  className={`w-full p-4 rounded-xl border text-left flex justify-between items-center transition-all ${selectedModel === m.id ? 'bg-emerald-500/10 border-emerald-500 text-emerald-400' : 'bg-black border-white/5 text-zinc-600'}`}
                >
                  <span className="text-[10px] font-bold">{m.label}</span>
                  {selectedModel === m.id && <span className="text-[10px]">‚óè</span>}
                </button>
              ))}
            </div>
          </aside>

          <main className="lg:col-span-8 space-y-6">
            <div className="grid grid-cols-3 gap-4">
              {[
                { label: 'Mutated', val: metrics.mutations, color: 'text-emerald-500' },
                { label: 'Progress', val: `${metrics.progress}%`, color: 'text-white' },
                { label: 'Faults', val: metrics.errors, color: 'text-red-500' }
              ].map(stat => (
                <div key={stat.label} className="bg-zinc-900/40 border border-white/5 p-6 rounded-[2rem] text-center">
                  <div className={`text-2xl font-black ${stat.color}`}>{stat.val}</div>
                  <div className="text-[8px] font-black uppercase tracking-widest text-zinc-700 mt-1">{stat.label}</div>
                </div>
              ))}
            </div>

            <div className="bg-black border border-white/5 rounded-[2.5rem] h-[450px] flex flex-col overflow-hidden relative">
              <div className="p-6 border-b border-white/5 bg-zinc-900/20 flex justify-between items-center">
                <span className="text-[10px] font-black text-emerald-500 uppercase tracking-[0.2em]">Live Telemetry</span>
                <div className="flex gap-1">
                  <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                  <div className="w-1.5 h-1.5 rounded-full bg-zinc-800"></div>
                </div>
              </div>
              <div className="flex-1 overflow-y-auto p-6 space-y-2 scrollbar-hide">
                {logs.map(log => (
                  <div key={log.id} className="text-[11px] flex gap-4 group">
                    <span className="text-zinc-800 font-bold shrink-0">{log.timestamp}</span>
                    <span className={`transition-all ${log.type === 'success' ? 'text-emerald-400' : log.type === 'error' ? 'text-red-400' : 'text-zinc-500'}`}>
                      {log.msg}
                    </span>
                  </div>
                ))}
                {!logs.length && <div className="text-zinc-800 italic text-[11px] h-full flex items-center justify-center">Awaiting System Ignition...</div>}
              </div>
              {isLive && (
                <div className="absolute bottom-0 left-0 w-full h-1 bg-zinc-900">
                  <div 
                    className="h-full bg-emerald-500 transition-all duration-1000" 
                    style={{ width: `${metrics.progress}%` }}
                  ></div>
                </div>
              )}
            </div>
          </main>
        </div>
      </div>
      <style>{`
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        * { scroll-behavior: smooth; }
      `}</style>
    </div>
  );
}

