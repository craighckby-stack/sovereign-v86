import sys
from types import FrameType
from typing import Any, Callable, Optional, Final

# --- Configuration and State Management ---

# Define the name of the sensitive variable using typing.Final for immutability clarity.
SENSITIVE_VARIABLE_NAME: Final[str] = 'my_secret_variable'

# Global state to store the previous trace function for proper restoration (best practice).
_ORIGINAL_TRACE_FUNCTION: Optional[Callable] = None

def _scrub_sensitive_variable_trace_handler(
    frame: FrameType, 
    event: str, 
    arg: Any
) -> Optional[Callable]:
    """
    High-performance trace handler executed on every line/event.

    This function is optimized for speed, performing a direct check and deletion
    of the sensitive variable from the frame's local scope (f_locals).
    """
    # Access locals directly for maximum performance in this high-frequency context.
    f_locals = frame.f_locals

    # Optimized check and delete block.
    if SENSITIVE_VARIABLE_NAME in f_locals:
        del f_locals[SENSITIVE_VARIABLE_NAME]

    # Must return the function itself to continue tracing the next line/event.
    return _scrub_sensitive_variable_trace_handler

def enable_sensitive_variable_scrubbing() -> None:
    """
    Activates the global system trace function, installing the scrubber handler.
    
    Stores the previously active trace function for safe restoration.
    """
    global _ORIGINAL_TRACE_FUNCTION
    
    # Check if tracing is already active via this mechanism.
    if _ORIGINAL_TRACE_FUNCTION is None:
        _ORIGINAL_TRACE_FUNCTION = sys.gettrace()

    # Apply the optimized trace handler.
    sys.settrace(_scrub_sensitive_variable_trace_handler)

def disable_sensitive_variable_scrubbing() -> None:
    """
    Restores the system trace function to the state it was in before scrubbing 
    was enabled, ensuring proper cleanup of global state.
    """
    global _ORIGINAL_TRACE_FUNCTION
    
    if _ORIGINAL_TRACE_FUNCTION is not None:
        sys.settrace(_ORIGINAL_TRACE_FUNCTION)
        _ORIGINAL_TRACE_FUNCTION = None

# --- Execution ---
# Apply the trace function globally, replicating the original file's immediate activation.
enable_sensitive_variable_scrubbing()